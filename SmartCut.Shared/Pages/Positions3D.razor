@page "/positions3d/{CuttingPlanId:int}"
@using SmartCut.Shared.Models
@using SmartCut.Shared.Models.DTOs
@using SmartCut.Shared.Models.ViewModels
@using SmartCut.Shared.Services
@using SmartCut.Shared.Resources.Localization
@implements IAsyncDisposable
@inject NotificationService NotificationService
@inject BreadcrumbService BreadcrumbService
@inject NavigationManager NavigationManager
@inject ApiClient DataService
@inject IJSRuntime JS

<h3>3D Positions View</h3>

<div id="three-container" style="width: 100%;
        height: 600px;border:1px solid #ccc;"></div>
<!-- tooltip injected / managed by JS, but keep a placeholder for CSS to apply -->
<div id="three-tooltip" style="display:none;"></div>

<button @onclick="Reload">Reload</button>
@* <button @onclick="DisposeJs">Destroy Viewer</button>
 *@
@code {
    // Replace this with DB loaded data in real usage
    [Parameter]
    public int CuttingPlanId { get; set; }
    private string uniqueKey = Guid.NewGuid().ToString();
    private List<Position> Positions = new List<Position>();
    private Dictionary<int, string> OrderNumbers = new Dictionary<int, string>();
    private Block? block { get; set; } 

    protected override async Task OnInitializedAsync()
    {
        try
        {
            BreadcrumbService.SetBreadcrumbs(new List<BreadcrumbItem>
            {
                new() { Title = Localizer.Get("Home"), Url = "/", IsActive = false },
                new() { Title = Localizer.Get("Plans"), Url = "/calculation", IsActive = false },
                new() { Title = Localizer.Get("Plan List"), Url = "/list-calculations", IsActive = false },
                new() { Title = Localizer.Get("Visualize Result"), Url = $"/positions3d/{CuttingPlanId}", IsActive = true }

            });
            CuttingPlanDTO cuttingPlan = await DataService.GetCuttingPlanByIdAsync(CuttingPlanId);
            if (cuttingPlan == null)
            {
                NotificationService.ShowError(Localizer.Get("Cutting plan not found."));
                return;
            }
            else if(cuttingPlan.CutEntries == null)
            {
                NotificationService.ShowError(Localizer.Get("Cutting plan not found."));
                return;
            }
            else if(cuttingPlan.CutEntries.Count == 0)
            {
                NotificationService.ShowError(Localizer.Get("Cutting plan not found."));
                return;
            }
            foreach(var item in cuttingPlan.CutEntries)
            {
                string orderNumber = String.Format("{0}-{1}", item.Order.InvoiceNumber, item.Order.Line);
                int orderId = item.OrderLineId;
                if(!OrderNumbers.ContainsKey(orderId))
                    OrderNumbers.Add(orderId, orderNumber);

                if(item.Positions != null)
                {
                    if(item.Positions.Count > 0)
                    {
                        foreach (var pos in item.Positions)
                            Positions.Add(pos);
                    }
                       
                }
            }

            block = cuttingPlan.Block;
            
            if(block == null)
            {
                NotificationService.ShowError(Localizer.Get("Block data not found."));
                return;
            }
            await JS.InvokeVoidAsync("renderPositions3D", block, Positions, OrderNumbers);
        }
        catch (Exception ex)
        {
            NotificationService.ShowError(Localizer.Get("An error occurred while visualizing result."));
            await JS.InvokeVoidAsync("destroyPositions3D");
            NavigationManager.NavigateTo("/list-calculations");
        }
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // First time render
            await JS.InvokeVoidAsync("destroyPositions3D");
        }
    }

    private async Task Reload()
    {  
        // Change key so Blazor re-renders entire div — like a mini hard reload
        uniqueKey = Guid.NewGuid().ToString();
        await InvokeAsync(StateHasChanged);

        // Wait for DOM to update, then re-run JS
        await Task.Delay(100);
        await JS.InvokeVoidAsync("renderPositions3D", block, Positions, OrderNumbers);
    }

    private async Task DisposeJs()
    {
        await JS.InvokeVoidAsync("destroyPositions3D");
    }
    public async ValueTask DisposeAsync()
    {
        try
        {
            // Wait for JS cleanup to fully finish
            await JS.InvokeAsync<bool>("destroyPositions3D");
        }
        catch (JSException jsex)
        {
            Console.Error.WriteLine($"JS cleanup failed: {jsex.Message}");
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"DisposeAsync exception: {ex}");
        }
    }

}
